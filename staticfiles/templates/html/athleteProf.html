<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Header -->
    {% include 'html/header.html' %}
</head>

<body>

    <!-- SideNavbar -->
    {% include 'html/sidenav.html' %}
    <main class="py-3" style="padding-top: 0 !important; padding-bottom: 0 !important;">
        <div class="container" style="max-width: 1800px;">
            <div class="row">
                <div class="col-lg-5 overflow-scroll">
                    <div class="col-scroll">

                        <!-- Athlete Info/Header -->
                        <div class="main-header justify-content-between">
                            <h1>{{ athleteProf.fname }} {{ athleteProf.lname }}</h1>
                            <i class="fa-solid fa-pen" style="color: var(--yellow-accent); font-size: var(--icon-size);"></i>
                        </div>

                        <div class="d-flex" style="height: 200px;">
                            {% if testType %}
                            <img class="athlete-pic" src="/staticfiles/images/{{ athleteProf.image }}"></img>
                            {% else %}
                            <img class="athlete-pic" src="/staticfiles/images/{{ athleteProf.image }}"></img>
                            {% endif %}
                            <div class="w-100" style="margin-left: var(--inner-padding);">
                                <div class="d-flex justify-content-between">
                                    <h6>Sport</h6>
                                    <h6 class="text-end">{{ athleteProf.sportsteam }}</h6>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between">
                                    <h6>Position</h6>
                                    <h6 class="text-end">{{ athleteProf.position }}</h6>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between">
                                    <h6>Year</h6>
                                    <h6 class="text-end">{{ athleteProf.year }}</h6>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between">
                                    <h6>Height</h6>
                                    <h6 class="text-end">{{ athleteProf.height }}</h6>
                                </div>

                                <!--<div class="line-2"></div>
                                <div style="display: flex; justify-content: space-between;">
                                    <h6>DOB</h6> <h6>{{ athleteProf.DOB }}</h6>
                                </div> -->
                            </div>
                        </div>

                        <!-- KPI Trends -->
                        <div class="kpireport">
                            <div class="d-flex justify-content-between align-items-center">
                                <h3>KPI Trends</h3>
                                <div class="text-end d-flex">
                                    <p style="font-size: 16px" id="resultone"></p>
                                    <p style="font-size: 16px">&nbsp; to &nbsp;</p>
                                    <p style="font-size: 16px" id="resulttwo"></p>
                                </div>
                            </div>

                            <hr>

                            <div id="kpi-trend">
                                <p style="margin-bottom: 0;">No data</p>
                            </div>

                            <a href="{% url 'AddKPI' athleteProf.fname athleteProf.lname athleteProf.dob %}">
                                <button class="kpidatabtn" style="margin-top: var(--inner-padding);">Add KPI</button>
                            </a>

                        </div>

                        <!-- Wellness Form -->
                        <!-- Right now, this wellness form works by refreshing the page, which re-runs the code in the script below
                        We need to get those values to update using AJAX -->
                        <form method="post" id="wellnessform">
                            {% csrf_token %}
                            <div class="d-flex justify-content-between">
                                <select id="wellnessdate" name="wellnessdate">
                                    <option disabled hidden selected>Select Date</option>
                                    {% for x in wellnessReportDates %}
                                    <option>{{ x.date }}</option>
                                    {% endfor %}
                                </select>
                                <input type="submit" value="submit" class="submit">
                                <p style="font-size: 16px" id="wellnessresult">DD/MM/YY</p>
                            </div>
                        </form>

                        <!-- Wellness Display -->

                        {% if wellness %}
                        {% for x in mostRecentWellnessReport %}

                        <div class="d-flex">
                            <div class="w-100 wellness-status-display" style="margin-right: 12px;" id="bor">
                                <h4 id="stat">Status: {{ x.status }}</h4>
                            </div>
                            <div class="w-100 wellness-status-display"
                                style="margin-left: 12px; border: 1px solid white;">
                                <div class="d-flex justify-content-center">
                                    <h4>Readiness: &nbsp;</h4>
                                    <h4 id="total"></h4>
                                </div>
                            </div>
                        </div>

                        <a href="{% url 'AddWellness' athleteProf.fname athleteProf.lname athleteProf.dob %}">
                            <button class="kpidatabtn" style="margin-top: 20px;">Add Wellness Report</button>
                        </a>

                        <script type="text/javascript">

                            // Get individual values needed for wellness total and then sum them
                            var hoursofsleep = Number("{{ x.hoursofsleep }}")
                            var sleepquality = Number("{{ x.sleepquality }}")
                            var breakfast = Number("{{ x.breakfast }}")
                            var hydration = Number("{{ x.hydration }}")
                            var soreness = Number("{{ x.soreness }}")
                            var stress = Number("{{ x.stress }}")
                            var mood = Number("{{ x.mood }}")

                            console.log(hoursofsleep)

                            var total = hoursofsleep + sleepquality + breakfast + hydration + soreness + stress + mood
                            // Update total in document
                            document.getElementById("total").innerHTML = total

                            function status() {
                                var status = "{{ x.status }}"

                                if (status == 'N') {
                                    document.getElementById("stat").style.color = "var(--red-accent)"
                                    document.getElementById("bor").style.border = "1px solid var(--red-accent)"
                                }
                                else if (status == 'Y') {
                                    document.getElementById("stat").style.color = "var(--green-accent)"
                                    document.getElementById("bor").style.border = "1px solid var(--green-accent)"
                                }
                            }

                            window.onload = function () {
                                status();
                            };



                        // Code for Wellness AJAX Request:

                        /* getCookie() function definition*/
                          // Definition for "getCookie" function, which will return a cookie from the document matching the parameter "name".
                          // This is a utility funciton utilized to send and AJAX request (see next code block)

                          // Cookie is initialized to null
                          // If there is are document cookies and they are NOT empty, the cookies in the document are fetched and placed in an array
                          // This array is searched for a cookie that matches parameter "name"
                          // If such a cookie is found, it is returned.
                          function getCookie(name) {
                            let cookieValue = null;
                            if (document.cookie && document.cookie !== "") {
                              const cookies = document.cookie.split(";");
                              for (let i = 0; i < cookies.length; i++) {
                                const cookie = cookies[i].trim();
                                // Does this cookie string begin with the name we want?
                                if (cookie.substring(0, name.length + 1) === (name + "=")) {
                                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                  break;
                                }
                              }
                            }

                            return cookieValue;
                          }
                        /* End of getCookie() function definition*/

                        /* When the "#wellnessform" form is submitted, this function will send an AJAX request to fetch the new data. */
                          $("#wellnessform").submit(function (event) {

                            // Override default behavior for 'submit'
                            event.preventDefault();

                            // Get value of #sportsteam
                            var date_selected = document.getElementById("wellnessdate").value
                            //alert(date_selected);

                            // Send "POST" AJAX request to url 'AthleteProf'
                            // This request will be handled by the Django backend -> see views.py recordKPI() for that code
                            $.ajax({
                              //URL needs to be fname, lname, DOB for athletes
                              url: "{% url 'AthleteProf' athleteProf.fname athleteProf.lname athleteProf.dob %}",
                              type: "POST",
                              dataType: "json",
                              data: JSON.stringify({ wellnessdate: date_selected, }),
                              headers: {
                                "X-Requested-With": "XMLHttpRequest",
                                "X-CSRFToken": getCookie("csrftoken"),  // don't forget to include the 'getCookie' function
                              },
                              success: (response) => {

                                document.getElementById("stat").style.color = "var(--green-accent)"
                                document.getElementById("bor").style.border = "1px solid var(--green-accent)"

                                // Get individual values needed for wellness total and then sum them

                                var hoursofsleep = Number( response.wellness[0].hoursofsleep )
                                var sleepquality = Number( response.wellness[0].sleepquality )
                                var breakfast = Number( response.wellness[0].breakfast )
                                var hydration = Number( response.wellness[0].hydration )
                                var soreness = Number( response.wellness[0].soreness )
                                var stress = Number( response.wellness[0].stress )
                                var mood = Number( response.wellness[0].mood )

                                console.log(hoursofsleep)

                                var total = hoursofsleep + sleepquality + breakfast + hydration + soreness + stress + mood
                                // Update total in document
                                document.getElementById("total").innerHTML = total

                                var status = response.wellness[0].status

                                if (status == 'N') {
                                    document.getElementById("stat").style.color = "var(--red-accent)"
                                    document.getElementById("bor").style.border = "1px solid var(--red-accent)"
                                }
                                else if (status == 'Y') {
                                    document.getElementById("stat").style.color = "var(--green-accent)"
                                    document.getElementById("bor").style.border = "1px solid var(--green-accent)"
                                }

                                // Update wellness result
                                document.getElementById("wellnessresult").innerHTML = response.wellness[0].date

                              },
                              error: (error) => {

                                console.log(error);
                                alert("Pause");
                              }
                            })
                          });
                        /* End of "#sportsteam" change function */
                        </script>

                        {% endfor %}
                        {% endif %}
                    </div>
                </div>

                <div class="col-lg-7 overflow-scroll">
                    <div class="col-scroll">

                        <!-- Date Selector + Settings-->
                        <div class="main-header justify-content-between">
                            <form method="post" id="kpiform" name="kpiform">
                                {% csrf_token %}
                                <select id="date1" name="date1" style="font-size:20px;">
                                    <option selected>{{ kpi_earliest }}</option>
                                    {% for x in all_dates %}
                                    <option>{{ x.datekpi }}</option>
                                    {% endfor %}
                                </select>
                                to
                                <select id="date2" name="date2" style="font-size:20px;">
                                    <option selected>{{ kpi_most_recent }}</option>
                                    {% for x in all_dates %}
                                    <option>{{ x.datekpi }}</option>
                                    {% endfor %}
                                </select>
                            </form>
                            <div class="d-flex align-items-center" style="gap:var(--inner-padding);">
                                <h4>Bar Graph</h4>
                                <h4>Spider Graph</h4>
                                <i class="fa-solid fa-gear" style="color: var(--yellow-accent); font-size: var(--icon-size);"></i>
                            </div>
                        </div>

                        <div id="bar-graphs" class="graphprof d-flex flex-column">
                            <p style="margin-bottom: 0; align-self: center;">No data</p>
                        </div>

                        <script>

                            //on window load, call ajax to populate page with data
                            window.onload = function () {

                                //only request data if there are kpis to display
                                var kpi_count = "{{kpi_count}}";

                                if (kpi_count > 0)
                                    ajax();

                                dataUpdater();
                            }

                            //django-provided code to assist ajax
                            function getCookie(name) {
                                let cookieValue = null;
                                if (document.cookie && document.cookie !== "") {
                                    const cookies = document.cookie.split(";");
                                    for (let i = 0; i < cookies.length; i++) {
                                        const cookie = cookies[i].trim();
                                        // Does this cookie string begin with the name we want?
                                        if (cookie.substring(0, name.length + 1) === (name + "=")) {
                                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                            break;
                                        }
                                    }
                                }

                                return cookieValue;
                            }

                            //if a date selector changes, call ajax to update the page
                            document.getElementById("date1").addEventListener("change", ajax);
                            document.getElementById("date2").addEventListener("change", ajax);

                            //grabs info from the database without refreshing page and screwing everything up
                            function ajax() {

                                //get dates from selectors
                                var date_one = document.getElementById("date1").value
                                var date_two = document.getElementById("date2").value

                                //clear trends and graphs 
                                $("#kpi-trend").empty()
                                $("#bar-graphs").empty()

                                //add loading circle
                                $("#kpi-trend").append("<div class=\"d-flex justify-content-center\"> <div id=\"loading-line\" class=\"lds-dual-ring\"></div></div>");
                                $("#bar-graphs").append("<div class=\"d-flex justify-content-center\"> <div id=\"loading-bar\" class=\"lds-dual-ring\"></div></div>");

                                $.ajax({
                                    url: "{% url 'AthleteProf' athleteProf.fname athleteProf.lname athleteProf.dob %}",
                                    type: "POST",
                                    dataType: "json",
                                    data: JSON.stringify({ date1: date_one, date2: date_two }),
                                    headers: {
                                        "X-Requested-With": "XMLHttpRequest",
                                        "X-CSRFToken": getCookie("csrftoken"),
                                    },
                                    success: (response) => {

                                        //shows info being passed from backend
                                        console.log(response);

                                        //remove loading circle after info arrives from db
                                        $("#loading-line").remove()
                                        $("#loading-bar").remove()

                                        //loop thru each test type and get its info
                                        for (var key in response.test_types) {
                                            var report = "<div class=\"d-flex justify-content-between align-items-center kpi-img\">";
                                            var graphs = "<div>";
                                            report += "<div style=\"width: 25%\"> <p>" + response.test_types[key] + "</p></div>";

                                            // add change
                                            if (response.changes[key] > 0)
                                                report += "<p style=\"color:var(--green-accent);\"> <i class=\"fa-solid fa-arrow-up\" style=\"color:var(--green-accent)\"></i> " + response.changes[key] + " </p>";
                                            else if (response.changes[key] < 0)
                                                report += "<p style=\"color:var(--red-accent);\"> <i class=\"fa-solid fa-arrow-down\" style=\"color:var(--red-accent)\"></i> " + response.changes[key] + " </p>";
                                            else
                                                report += "<p style\"=color:white;\"> " + response.changes[key] + " </p>";

                                            //add line graph with results below
                                            report += "<div style=\"width: 50%;\"> <img src=\"data:image/png;base64, " + response.kpi_line[key] + "\">";
                                            report += "<div class=\"d-flex justify-content-between align-items-center\"> <p>" + response.Date1_results[key] + "</p> <p>" + response.Date2_results[key] + "</p></div>";
                                            report += "</div>";
                                            report += "</div>";

                                            //add bar graphs with test name
                                            graphs += "<h3>" + response.test_types[key] + "</h3>";
                                            graphs += "<img src=\"data:image/png;base64, " + response.kpi_bar[key] + "\">";
                                            graphs += "</div>";

                                            $("#kpi-trend").append(report);
                                            $("#kpi-trend").append("<hr>");

                                            $("#bar-graphs").append(graphs);
                                        }

                                    },
                                    error: (error) => {
                                        console.log("Couldn't complete request: " + error);
                                    }
                                })
                            }

                            function dateUpdater() {

                                let selection1 = document.getElementById('date1');
                                let date1 = document.getElementById('resultone');

                                var date_one = "{{ date_one }}"
                                document.getElementById("resultone").innerHTML = date_one
                                if (date_one != "None")
                                    document.getElementById("resultone").innerHTML = date_one
                                else
                                    document.getElementById("resultone").innerHTML = "None";

                                let selection2 = document.getElementById('date2');
                                let date2 = document.getElementById('resulttwo');

                                var date_two = "{{ date_two }}"
                                document.getElementById("resulttwo").innerHTML = date_two
                                if (date_two != "None")
                                    document.getElementById("resulttwo").innerHTML = date_two
                                else
                                    document.getElementById("resulttwo").innerHTML = "None";

                                let selection3 = document.getElementById('wellnessdate');
                                let date3 = document.getElementById('wellnessresult');

                                var mostrecentdate = "{{ mostRecentWellnessReportDate }}"
                                document.getElementById("wellnessresult").innerHTML = mostrecentdate
                                var wellness_date = "{{ wellness_date }}"

                                if (wellness_date != "None") {
                                    document.getElementById("wellnessresult").innerHTML = wellness_date
                                }

                                selection1.addEventListener('change', () => {
                                    resultone.innerText = selection1.options[selection1.selectedIndex].text;
                                });

                                selection2.addEventListener('change', () => {
                                    resulttwo.innerText = selection2.options[selection2.selectedIndex].text;
                                });

                                selection3.addEventListener('change', () => {
                                    wellnessresult.innerText = selection3.options[selection3.selectedIndex].text;
                                });
                            }

                        </script>
                    </div>
                </div>
            </div>
        </div>
    </main>
</body>
