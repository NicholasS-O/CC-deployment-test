<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Header -->
    {% include 'html/header.html' %}
</head>

<body>

    <!-- SideNavbar -->
    {% include 'html/sidenav.html' %}
    <main class="py-3 py-override">
        <div class="container" style="max-width: 1800px;">
            <div class="row">
                <div class="col-lg-5 overflow-scroll">
                    <div class="col-scroll">
                        
                        <!-- Athlete Info/Header -->
                        <div class="main-header justify-content-between">
                            <div class="d-flex align-items-center" style="gap: 15px;">
                                <a href="/athletes"><i class="fa-solid fa-chevron-left" style="color: var(--yellow-accent); margin-bottom: 4px;"></i></a>
                                <h1>{{ athleteProf.fname }} {{ athleteProf.lname }}</h1>
                            </div>
                            <div class="justify-content-between">
                                <label for="id_image">
                                    <i class="fa-solid fa-camera" style="color: var(--yellow-accent); font-size: var(--icon-size); cursor: pointer;"></i>
                                </label>
                                &nbsp;
                                <a href="{% url 'EditAthlete' athleteProf.fname athleteProf.lname athleteProf.dob athleteProf.id %}">
                                    <i class="fa-solid fa-pen" style="color: var(--yellow-accent); font-size: var(--icon-size);"></i>
                                </a>
                            </div>
                        </div>

                        <!-- Hidden Input Field to change an image -->
                        <form method="post" enctype="multipart/form-data" style="display: none;" id="imgForm">  
                            {% csrf_token %}  
                            {{ form.image }}  
                        </form>

                        <div class="d-flex">
                            
                            <img class="athlete-pic" src="/media/{{ athleteProf.image }}" id="profileImg"></img>

                            <div class="w-100" style="margin-left: var(--inner-padding);">
                                <div class="d-flex justify-content-between">
                                    <h6>Sport</h6>
                                    <h6 class="text-end">{{ athleteProf.sportsteam }}</h6>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between">
                                    <h6>Position</h6>
                                    <h6 class="text-end">{{ athleteProf.position }}</h6>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between">
                                    <h6>Year</h6>
                                    <h6 class="text-end">{{ athleteProf.year }}</h6>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between">
                                    <h6>Height</h6>
                                    <h6 class="text-end">{{ athleteProf.height }}</h6>
                                </div>
                            </div>
                        </div>

                        <!-- KPI/Wellness Tabs-->
                        <div class="d-flex" style="margin-top: var(--inner-padding);">
                            <button id="kpi-tab" class="report-tab">KPI</button>
                            <button id="wellness-tab" class="report-tab">Wellness</button>
                        </div>

                        <script>
                            //jQuery for kpi and wellness "tabs", allowing only one or the other to be shown
                            //at a given time
                            $(document).ready(function () {

                                //initially hide wellness report and show only kpi trends
                                $("#wellnessreport").hide();
                                document.getElementById("wellness-tab").style.backgroundColor = "#191A1C";

                                //upon click of wellness tab, show wellnessreport div & hide kpireport div
                                //swap color of tab
                                $("#wellness-tab").click(function () {
                                    $("#kpireport").hide();
                                    $("#wellnessreport").show();
                                    document.getElementById("wellness-tab").style.backgroundColor = "var(--med-gray-2)";
                                    document.getElementById("kpi-tab").style.backgroundColor = "#191A1C";
                                });

                                //upon click of kpi tab, show kpireport div & hide wellnessreport div
                                //swap color of tab
                                $("#kpi-tab").click(function () {
                                    $("#kpireport").show();
                                    $("#wellnessreport").hide();
                                    document.getElementById("kpi-tab").style.backgroundColor = "var(--med-gray-2)";
                                    document.getElementById("wellness-tab").style.backgroundColor = "#191A1C";
                                });
                            });
                        </script>

                        <!-- KPI Trends -->
                        <div id="kpireport" class="report tab-corner bottom-margin">

                            <div class="d-flex justify-content-between align-items-center">
                                <div style="width: 50%">
                                    <h3>KPI Trends</h3>
                                </div>
                                <div class="d-flex justify-content-between" style="width: 50%;">
                                    <p style="font-size: 16px" id="resultone"></p>
                                    <p style="font-size: 16px" id="resulttwo"></p>
                                </div>
                            </div>

                            <hr>

                            <div id="kpi-trend">
                                <p style="margin-bottom: 0;">No data</p>
                            </div>

                            <a href="{% url 'AddKPI' athleteProf.fname athleteProf.lname athleteProf.dob %}">
                                <button class="kpidatabtn" style="margin-top: var(--inner-padding);">Add KPI</button>
                            </a>

                        </div>

                        <div id="wellnessreport" class="report tab-corner" style="display: none;">

                            <!-- Wellness Header & Date Selector -->
                            <div class="d-flex justify-content-between">
                                <h3>Wellness</h3>
                                <form method="post" id="wellnessform">
                                    {% csrf_token %}
                                    <div class="d-flex justify-content-between">
                                        <select id="wellnessdate" name="wellnessdate">
                                            <option selected>{{ mostRecentWellnessReportDate }}</option>
                                            {% for x in wellnessReportDates %}
                                            <option>{{ x.date }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </form>
                            </div>

                            <!-- Wellness Display -->
                            <div style="margin-top: var(--inner-padding);">
                                <div class="d-flex">
                                    <div class="w-100 wellness-status-display"
                                        style="margin-right: calc(var(--inner-padding)/2);" id="bor">
                                        <div class="d-flex justify-content-center">
                                            <h4 id="stat"></h4>
                                        </div>
                                    </div>
                                    <div class="w-100 wellness-status-display"
                                        style="margin-left: calc(var(--inner-padding)/2); border: 1px solid white;">
                                        <div class="d-flex justify-content-center">
                                            <h4 id="total"></h4>
                                        </div>
                                    </div>
                                </div>
                                <div style="margin-top: var(--inner-padding);">
                                    <table class="table wellness-table"
                                        style="border-color: rgba(255, 255, 255, 0.321); color: white;">
                                        <tr>
                                            <td>
                                                <h6>Hours of Sleep</h6>
                                                <h6 id="hrs_sleep"></h6>
                                            </td>
                                            <td>
                                                <h6>Sleep Quality</h6>
                                                <h6 id="sleep_qual"></h6>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <h6>Breakfast</h6>
                                                <h6 id="breakfast"></h6>
                                            </td>
                                            <td>
                                                <h6>Hydration</h6>
                                                <h6 id="hydration"></h6>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <h6>Soreness</h6>
                                                <h6 id="soreness"></h6>
                                            </td>
                                            <td>
                                                <h6>Stress</h6>
                                                <h6 id="stress"></h6>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style="border-bottom: none;">
                                                <h6>Mood</h6>
                                                <h6 id="mood"></h6>
                                            </td>
                                            <td style="border-bottom: none;">
                                                <h6><strong>Total</strong></h6>
                                                <h6 id="wellness_total"></h6>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </div>

                            <a href="{% url 'AddWellness' athleteProf.fname athleteProf.lname athleteProf.dob %}">
                                <button class="kpidatabtn" style="margin-top: 20px;">Add Wellness Report</button>
                            </a>

                        </div>
                    </div>
                </div>

                <div class="col-lg-7 overflow-scroll">
                    <div class="col-scroll">

                        <!-- Date Selector + Settings-->
                        <div class="main-header justify-content-between">
                            <form method="post" id="kpiform" name="kpiform">
                                {% csrf_token %}
                                <select id="date1" name="date1" style="font-size:20px;">
                                    <option selected>{{ kpi_earliest }}</option>
                                    {% for x in all_dates %}
                                    <option>{{ x.datekpi }}</option>
                                    {% endfor %}
                                </select>
                                to
                                <select id="date2" name="date2" style="font-size:20px;">
                                    <option selected>{{ kpi_most_recent }}</option>
                                    {% for x in all_dates %}
                                    <option>{{ x.datekpi }}</option>
                                    {% endfor %}
                                </select>
                            </form>
                            <div class="d-flex align-items-center" style="gap:var(--inner-padding);">
                                <!-- Bar/Spider Chart Tabs-->
                                <div class="d-flex" style="height: 100%; margin-top: 6px;">
                                    <button id="bar-tab" class="report-tab" style="padding: 15px 25px;">Bar Chart</button>
                                    <button id="spider-tab" class="report-tab" style="padding: 15px 25px;">Spider Chart</button>
                                </div>
                                <i class="fa-solid fa-gear" id="settings"
                                    style="color: var(--yellow-accent); font-size: var(--icon-size); z-index: 2;"></i>

                                <div id="options-card" class="options-card" style="display: none;">
                                    <h4>Settings</h4>
                                    <ul>
                                        <li>Show Team Avg<input id="i-show_fullname" type="checkbox" checked="true"></li>
                                        <li>Show Gender Avg<input id="i-show_trends" type="checkbox" checked="true"></li>
                                        <li>Show Position Avg<input id="i-show_pos" type="checkbox" checked="true"></li>
                                        <hr>
                                        <li>Standard Deviation<input id="i-show_fullname" type="checkbox" checked="true"></li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <script>
                            //jQuery for kpi and wellness "tabs", allowing only one or the other to be shown
                            //at a given time
                            $(document).ready(function () {

                                //initially hide wellness report and show only kpi trends
                                document.getElementById("spider-tab").style.backgroundColor = "#191A1C";

                                //upon click of wellness tab, show wellnessreport div & hide kpireport div
                                //swap color of tab
                                $("#spider-tab").click(function () {
                                    $("#spider-graphs").show();
                                    $("#bar-graphs").hide();
                                    document.getElementById("spider-tab").style.backgroundColor = "var(--med-gray-2)";
                                    document.getElementById("bar-tab").style.backgroundColor = "#191A1C";
                                });

                                //upon click of kpi tab, show kpireport div & hide wellnessreport div
                                //swap color of tab
                                $("#bar-tab").click(function () {
                                    $("#spider-graphs").hide();
                                    $("#bar-graphs").show();
                                    document.getElementById("bar-tab").style.backgroundColor = "var(--med-gray-2)";
                                    document.getElementById("spider-tab").style.backgroundColor = "#191A1C";
                                });

                                // upon click of cog wheel "settings", show the options card
                                // if it's already showing, close it. functions as a toggle
                                $("#settings").click(function () {
                                    if ($('#options-card').is(':hidden')) {
                                        $("#options-card").show();
                                    } else {
                                        $("#options-card").hide();
                                    }

                                });
                            });
                        </script>

                        <div id="spider-graphs" style="display: none;">
                            <!-- Radar/Spider Graph -->
                            <div class="graphprof">
                                <form method="post" id="kpi_radar_form">
                                    {% csrf_token %}
                                    <div class="d-flex justify-content-between">
                                        <select id="radar_date" name="radar_date">
                                            <option disabled hidden selected>Select Date</option>
                                            <option selected>{{ kpi_most_recent }}</option>
                                            {% for x in all_dates %}
                                                <option>{{ x.datekpi }}</option>
                                            {% endfor %}
                                        </select>
                                        <input type="submit" value="submit" class="submit">
                                    </div>
                                    <br>
                                    <!-- If a date has been selected -->
                                    {% if radar_date %}
                                        <div>
                                            <form method="post" id="selected_radar_tests">
                                                {% csrf_token %}
                                                <!-- Passing radar_date as a session variable -->
                                                <input type="hidden" name="radar_date" id="radar_date_input" value="{{ radar_date }}">
                                                <!-- Checkboxes for the test types -->
                                                {% for test in all_tests %}
                                                    <input type="checkbox" id="{{ test }}" name="selected_radar_tests" value="{{ test }}">
                                                    <label for="{{ test }}">{{ test }}</label><br>
                                                {% endfor %}
                                                <hr> 
                                                <!-- Checkboxes for the averages to compare to -->                            
                                                <input type="checkbox" id="team_avg" name="compare_avg" value="team_avg">
                                                <label for="team_avg">Team Avg</label><br>
                                            
                                                <input type="checkbox" id="position_avg" name="compare_avg" value="position_avg">
                                                <label for="position_avg">Position Avg</label><br>
                                            
                                                <input type="checkbox" id="gender_avg" name="compare_avg" value="gender_avg">
                                                <label for="gender_avg">Gender Avg</label><br>
                                                <br>
                                                <input type="submit" value="Submit" class="submit">
                                            </form>                                            
                                        </div>
                                        <br>
                                        <!-- Display the spider graph or not -->
                                        {% if selected_radar_tests %}
                                            {% if selected_radar_tests|length > 2 %}
                                                {{ Radar_chart|safe }}
                                            {% else %}
                                                <p>Three tests are required to generate a spider graph.</p>
                                            {% endif %}
                                        {% endif %}
                                    {% endif %}
                                </form>
                            </div>
                        </div>

                        <div id="bar-graphs" class="graphprof d-flex flex-column">
                            <p style="margin-bottom: 0; align-self: center;">No data</p>
                        </div>

                        <script>

                            //on window load, call ajax to populate page with data
                            window.onload = function () {

                                //if there are kpis or wellness reports, submit an ajax request to get data on page load
                                var kpi_count = "{{ kpi_count }}";
                                var wellness_count = "{{ wellness_count }}";

                                if (kpi_count > 0)
                                    kpi_ajax();
                                if (wellness_count > 0)
                                    wellness_ajax();

                                dateUpdater();

                                //set dates on kpi-report div to the ones initially selected
                                document.getElementById("resultone").innerHTML = "{{ kpi_earliest }}";
                                document.getElementById("resulttwo").innerHTML = "{{ kpi_most_recent }}";
                            }

                            /* getCookie() function definition*/
                            // Definition for "getCookie" function, which will return a cookie from the document matching the parameter "name".
                            // This is a utility funciton utilized to send and AJAX request (see next code block)

                            // Cookie is initialized to null
                            // If there is are document cookies and they are NOT empty, the cookies in the document are fetched and placed in an array
                            // This array is searched for a cookie that matches parameter "name"
                            // If such a cookie is found, it is returned.
                            function getCookie(name) {
                                let cookieValue = null;
                                if (document.cookie && document.cookie !== "") {
                                    const cookies = document.cookie.split(";");
                                    for (let i = 0; i < cookies.length; i++) {
                                        const cookie = cookies[i].trim();
                                        // Does this cookie string begin with the name we want?
                                        if (cookie.substring(0, name.length + 1) === (name + "=")) {
                                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                            break;
                                        }
                                    }
                                }

                                return cookieValue;
                            }

                            // if img upload changes... 
                            document.getElementById("id_image").addEventListener("change", imgChange);
                            // stops form from resubmitting when page is refreshed to show 
                            if ( window.history.replaceState ) {
                                window.history.replaceState( null, null, window.location.href );
                            }

                            function imgChange() {
                                // submit the form to change database, and refresh the page to show new profile image
                                document.getElementById("imgForm").submit();
                                document.getElementById("imgForm").reset();
                                console.log("submit form")
                            }

                            //if a date selector changes, call ajax to update the page
                            document.getElementById("date1").addEventListener("change", kpi_ajax);
                            document.getElementById("date2").addEventListener("change", kpi_ajax);

                            //grabs info from the database without refreshing page and screwing everything up
                            function kpi_ajax() {

                                //get dates from selectors
                                var date_one = document.getElementById("date1").value
                                var date_two = document.getElementById("date2").value

                                //clear trends and graphs 
                                $("#kpi-trend").empty()
                                $("#bar-graphs").empty()

                                //add loading circle
                                $("#kpi-trend").append("<div id=\"loading-line\" class=\"d-flex justify-content-center\"> <div class=\"lds-dual-ring\"></div></div>");
                                $("#bar-graphs").append("<div id=\"loading-bar\" class=\"d-flex justify-content-center\"> <div class=\"lds-dual-ring\"></div></div>");

                                $.ajax({
                                    url: "{% url 'AthleteProf' athleteProf.fname athleteProf.lname athleteProf.dob athleteProf.id %}",
                                    type: "POST",
                                    dataType: "json",
                                    data: JSON.stringify({ date1: date_one, date2: date_two }),
                                    headers: {
                                        "X-Requested-With": "XMLHttpRequest",
                                        "X-CSRFToken": getCookie("csrftoken"),
                                    },
                                    success: (response) => {

                                        //shows info being passed from backend
                                        console.log(response);

                                        //remove loading circle after info arrives from db
                                        $("#loading-line").remove()
                                        $("#loading-bar").remove()

                                        //loop thru each test type and get its info
                                        for (var key in response.test_types) {
                                            var report = "<div class=\"d-flex justify-content-between align-items-center kpi-img\">";
                                            var graphs = "<div>";
                                            report += "<div style=\"width: 25%\"> <p>" + response.test_types[key] + "</p></div>";

                                            // If the change is increasing
                                            if (response.changes[key] > 0) {
                                                // If a minimum score is better for a test, the change is increasing and is red
                                                // (don't judge the === true and false, Ajax/JS didn't like the expression without them)
                                                if (response.minBetter[key] === true) {
                                                    report += "<p style=\"color:var(--red-accent);\"> <i class=\"fa-solid fa-arrow-up\" style=\"color:var(--red-accent)\"></i> " + response.changes[key] + " </p>";
                                                    // If a minimum score is NOT better for a test, the change is increasing and is green
                                                } else if (response.minBetter[key] === false) {
                                                    report += "<p style=\"color:var(--green-accent);\"> <i class=\"fa-solid fa-arrow-up\" style=\"color:var(--green-accent)\"></i> " + response.changes[key] + " </p>";
                                                    // minBetter is not defined, make it white/neutral (bodyweight, body composition, etc)
                                                } else {
                                                    report += "<p style=\"color:#FFFFFF;\"> <i class=\"fa-solid fa-arrow-up\" style=\"color:#FFFFFF\"></i> " + response.changes[key] + " </p>";
                                                }
                                                // If the change is decreasing
                                            } else if (response.changes[key] < 0) {
                                                // If a minimum score is better for a test, the change is decreasing and is green
                                                if (response.minBetter[key] === true) {
                                                    report += "<p style=\"color:var(--green-accent);\"> <i class=\"fa-solid fa-arrow-down\" style=\"color:var(--green-accent)\"></i> " + Math.abs(response.changes[key]) + " </p>";
                                                    // If a minimum score is NOT better for a test, the change is decreasing and is red
                                                } else if (response.minBetter[key] === false) {
                                                    report += "<p style=\"color:var(--red-accent);\"> <i class=\"fa-solid fa-arrow-down\" style=\"color:var(--red-accent)\"></i> " + Math.abs(response.changes[key]) + " </p>";
                                                    // minBetter is not defined, make it white/neutral (bodyweight, body composition, etc)
                                                } else {
                                                    report += "<p style=\"color:#FFFFFF;\"> <i class=\"fa-solid fa-arrow-down\" style=\"color:#FFFFFF\"></i> " + Math.abs(response.changes[key]) + " </p>";
                                                }
                                                // The change is 0, no arrow
                                            } else {
                                                report += "<p style=\"color:#FFFFFF;\"> " + response.changes[key] + " </p>";
                                            }

                                            //add line graph with results below
                                            report += "<div style=\"width: 50%;\"> <img src=\"data:image/png;base64, " + response.kpi_line[key] + "\">";
                                            report += "<div class=\"d-flex justify-content-between align-items-center\"> <p>" + response.Date1_results[key] + "</p> <p>" + response.Date2_results[key] + "</p></div>";
                                            report += "</div>";
                                            report += "</div>";

                                            //add bar graphs with test name
                                            graphs += "<h3>" + response.test_types[key] + "</h3>";
                                            graphs += "<img style=\"width: 100%; height:auto;\" src=\"data:image/png;base64, " + response.kpi_bar[key] + "\">";
                                            graphs += "</div>";

                                            $("#kpi-trend").append(report);
                                            $("#kpi-trend").append("<hr>");

                                            $("#bar-graphs").append(graphs);
                                        }

                                    },
                                    error: (error) => {
                                        console.log("Couldn't complete request: " + error);
                                    }
                                })
                            }

                            //if a date selector changes, call ajax to update the page 
                            document.getElementById("wellnessdate").addEventListener("change", wellness_ajax);

                            /* When the "#wellnessform" form is submitted, this function will send an AJAX request to fetch the new data. */
                            function wellness_ajax() {

                                // Get value of #sportsteam
                                var date_selected = document.getElementById("wellnessdate").value

                                // Send "POST" AJAX request to url 'AthleteProf'
                                // This request will be handled by the Django backend -> see views.py recordKPI() for that code
                                $.ajax({
                                    //URL needs to be fname, lname, DOB for athletes
                                    url: "{% url 'AthleteProf' athleteProf.fname athleteProf.lname athleteProf.dob athleteProf.id %}",
                                    type: "POST",
                                    dataType: "json",
                                    data: JSON.stringify({ wellnessdate: date_selected, }),
                                    headers: {
                                        "X-Requested-With": "XMLHttpRequest",
                                        "X-CSRFToken": getCookie("csrftoken"),  // don't forget to include the 'getCookie' function
                                    },
                                    success: (response) => {

                                        console.log(response);

                                        // Get individual values needed for wellness total and then sum them
                                        var hoursofsleep = Number(response.wellness[0].hoursofsleep);
                                        var sleepquality = Number(response.wellness[0].sleepquality);
                                        var breakfast = Number(response.wellness[0].breakfast);
                                        var hydration = Number(response.wellness[0].hydration);
                                        var soreness = Number(response.wellness[0].soreness);
                                        var stress = Number(response.wellness[0].stress);
                                        var mood = Number(response.wellness[0].mood);

                                        document.getElementById("hrs_sleep").innerText = hoursofsleep;
                                        document.getElementById("sleep_qual").innerText = sleepquality;
                                        document.getElementById("breakfast").innerText = breakfast;
                                        document.getElementById("hydration").innerText = hydration;
                                        document.getElementById("soreness").innerText = soreness;
                                        document.getElementById("stress").innerText = stress;
                                        document.getElementById("mood").innerText = mood;

                                        var total = hoursofsleep + sleepquality + breakfast + hydration + soreness + stress + mood;
                                        var status = response.wellness[0].status;

                                        // Update total & readiness in document
                                        document.getElementById("wellness_total").innerText = total;
                                        document.getElementById("total").innerHTML = "Readiness: " + total;
                                        document.getElementById("stat").innerHTML = "Status: " + status;

                                        if (status == 'Out') {
                                            document.getElementById("stat").style.color = "var(--red-accent)";
                                            document.getElementById("bor").style.border = "1px solid var(--red-accent)";
                                        }
                                        else if (status == 'Good') {
                                            document.getElementById("stat").style.color = "var(--green-accent)";
                                            document.getElementById("bor").style.border = "1px solid var(--green-accent)";
                                        }

                                    },
                                    error: (error) => {

                                        console.log(error);
                                        alert("Pause");
                                    }
                                })
                            }
                            /* End of "#sportsteam" change function */

                            function dateUpdater() {

                                let selection1 = document.getElementById('date1');
                                let selection2 = document.getElementById('date2');

                                selection1.addEventListener('change', () => {
                                    resultone.innerText = selection1.options[selection1.selectedIndex].text;
                                });

                                selection2.addEventListener('change', () => {
                                    resulttwo.innerText = selection2.options[selection2.selectedIndex].text;
                                });
                            }
                            console.log(window.performance);
                        </script>
                    </div>
                </div>
            </div>
        </div>
    </main>
</body>